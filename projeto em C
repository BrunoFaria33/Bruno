/* ===================================================================================
       SISTEMA DE GESTÃO DE ESTOQUE E VENDAS (C PURO)
-----------------------------------------------------------------------------------
   FUNCIONALIDADES:
   - Cadastro de Produtos
   - Cadastro de Vendedores
   - Saída de Mercadoria (Baixa no Estoque com Vendedor e Data)
   - Relatórios TXT
=================================================================================== */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

/* --- ESTRUTURAS DE DADOS --- */

typedef struct {
    char nome[50];
    int quantidade;
    float preco;
    char status; // ' ' = ativo
} Produto;

typedef struct {
    char nome[50];
    char status; // ' ' = ativo
} Vendedor;

/* --- PROTÓTIPOS --- */
void limpa_buffer(void);
void lerString(char *s, int tam);
int tamanho(FILE *arq, size_t tam_registro);
void cadastrarProduto(FILE *arq);
void cadastrarVendedor(FILE *arq);
void realizarVenda(FILE *arqProd, FILE *arqVend);
void consultarEstoque(FILE *arq);
void listarVendedores(FILE *arq);

/* ---- NOVAS FUNÇÕES PARA RELATÓRIOS TXT ---- */
void gerarRelatorioEstoque(FILE *arq);
void gerarRelatorioVendedores(FILE *arq);
void gerarRelatorioVenda(Produto p, Vendedor v, int qtd, const char *data);

/* ============================================================================== */
void limpa_buffer(void) {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

/* ============================================================================== */
void lerString(char *s, int tam) {
    fgets(s, tam, stdin);
    s[strcspn(s, "\n")] = '\0';
}

/* ============================================================================== */
int tamanho(FILE *arq, size_t tam_registro) {
    long pos = ftell(arq);
    fseek(arq, 0, SEEK_END);
    long fim = ftell(arq);
    fseek(arq, pos, SEEK_SET);
    return (int)(fim / tam_registro);
}

/* ============================================================================== */
void cadastrarProduto(FILE *arq) {
    Produto p;
    char conf;
    p.status = ' ';

    printf("\n--- NOVO PRODUTO ---\n");
    printf("Código gerado: %d\n", tamanho(arq, sizeof(Produto)) + 1);

    printf("Nome do Produto: ");
    lerString(p.nome, sizeof(p.nome));

    printf("Quantidade Inicial: ");
    scanf("%d", &p.quantidade);
    limpa_buffer();

    printf("Preço de Venda (R$): ");
    scanf("%f", &p.preco);
    limpa_buffer();

    printf("Salvar produto (s/n)? ");
    scanf("%c", &conf);
    limpa_buffer();

    if (toupper(conf) == 'S') {
        fseek(arq, 0, SEEK_END);
        fwrite(&p, sizeof(Produto), 1, arq);
        fflush(arq);
        printf("Produto cadastrado!\n");
    }
}

/* ============================================================================== */
void cadastrarVendedor(FILE *arq) {
    Vendedor v;
    char conf;
    v.status = ' ';

    printf("\n--- NOVO VENDEDOR ---\n");
    printf("Código gerado: %d\n", tamanho(arq, sizeof(Vendedor)) + 1);

    printf("Nome do Vendedor: ");
    lerString(v.nome, sizeof(v.nome));

    printf("Salvar vendedor (s/n)? ");
    scanf("%c", &conf);
    limpa_buffer();

    if (toupper(conf) == 'S') {
        fseek(arq, 0, SEEK_END);
        fwrite(&v, sizeof(Vendedor), 1, arq);
        fflush(arq);
        printf("Vendedor cadastrado!\n");
    }
}

/* ============================================================================== */
/* ---- FUNÇÃO PARA REALIZAR VENDA + GERAR RELATÓRIO TXT ---- */
void realizarVenda(FILE *arqProd, FILE *arqVend) {
    int codProd, codVend, qtdVenda;
    char data[12];
    Produto p;
    Vendedor v;

    printf("\n=== REGISTRAR SAÍDA / VENDA ===\n");

    printf("Código do Vendedor: ");
    scanf("%d", &codVend);
    limpa_buffer();

    long posVend = (long)(codVend - 1) * sizeof(Vendedor);
    fseek(arqVend, posVend, SEEK_SET);
    if (codVend <= 0 || fread(&v, sizeof(Vendedor), 1, arqVend) != 1) {
        printf("Erro: Vendedor não encontrado!\n");
        return;
    }

    printf("Código do Produto: ");
    scanf("%d", &codProd);
    limpa_buffer();

    long posProd = (long)(codProd - 1) * sizeof(Produto);
    fseek(arqProd, posProd, SEEK_SET);
    if (codProd <= 0 || fread(&p, sizeof(Produto), 1, arqProd) != 1) {
        printf("Erro: Produto não encontrado!\n");
        return;
    }

    printf("\nProduto: %s | Estoque Atual: %d\n", p.nome, p.quantidade);
    printf("Vendedor: %s\n", v.nome);

    printf("Quantidade vendida: ");
    scanf("%d", &qtdVenda);
    limpa_buffer();

    if (qtdVenda > p.quantidade) {
        printf("ERRO: Estoque insuficiente! Disponível: %d\n", p.quantidade);
        return;
    }

    printf("Data da venda (dd/mm/aa): ");
    lerString(data, sizeof(data));

    char conf;
    printf("Confirmar saída de %d un. de '%s' por %s? (s/n): ", qtdVenda, p.nome, v.nome);
    scanf("%c", &conf);
    limpa_buffer();

    if (toupper(conf) == 'S') {
        p.quantidade -= qtdVenda;

        fseek(arqProd, posProd, SEEK_SET);
        fwrite(&p, sizeof(Produto), 1, arqProd);
        fflush(arqProd);

        printf("\n[SUCESSO] Venda registrada!\n");

        /* ---- GERAR RELATÓRIO TXT DA VENDA ---- */
        gerarRelatorioVenda(p, v, qtdVenda, data);

    } else {
        printf("Venda cancelada.\n");
    }
}

/* ============================================================================== */
void consultarEstoque(FILE *arq) {
    Produto p;
    int i, total = tamanho(arq, sizeof(Produto));

    printf("\n=== RELATÓRIO DE ESTOQUE ===\n");
    printf("COD | %-20s | %-5s | %-10s\n", "PRODUTO", "QTD", "PREÇO");
    printf("------------------------------------------------\n");

    for (i = 0; i < total; i++) {
        fseek(arq, i * sizeof(Produto), SEEK_SET);
        fread(&p, sizeof(Produto), 1, arq);
        printf("%03d | %-20s | %03d   | R$ %.2f\n", i + 1, p.nome, p.quantidade, p.preco);
    }
}

/* ============================================================================== */
void listarVendedores(FILE *arq) {
    Vendedor v;
    int i, total = tamanho(arq, sizeof(Vendedor));

    printf("\n--- LISTA DE VENDEDORES ---\n");
    for (i = 0; i < total; i++) {
        fseek(arq, i * sizeof(Vendedor), SEEK_SET);
        fread(&v, sizeof(Vendedor), 1, arq);
        printf("#%d - %s\n", i + 1, v.nome);
    }
}

/* ============================================================================== */
/* ---- RELATÓRIO TXT DO ESTOQUE ---- */
void gerarRelatorioEstoque(FILE *arq) {
    FILE *rel = fopen("relatorio_estoque.txt", "w");
    if (!rel) {
        printf("Erro ao gerar arquivo TXT!\n");
        return;
    }

    Produto p;
    int i, total = tamanho(arq, sizeof(Produto));

    fprintf(rel, "======= RELATÓRIO DE ESTOQUE =======\n\n");
    for (i = 0; i < total; i++) {
        fseek(arq, i * sizeof(Produto), SEEK_SET);
        fread(&p, sizeof(Produto), 1, arq);
        fprintf(rel, "%03d - %-20s  QTD: %03d  PREÇO: R$ %.2f\n",
                i + 1, p.nome, p.quantidade, p.preco);
    }

    fclose(rel);
    printf("Relatório 'relatorio_estoque.txt' criado com sucesso!\n");
}

/* ============================================================================== */
/* ---- RELATÓRIO TXT DE VENDEDORES ---- */
void gerarRelatorioVendedores(FILE *arq) {
    FILE *rel = fopen("relatorio_vendedores.txt", "w");
    if (!rel) {
        printf("Erro ao gerar arquivo TXT!\n");
        return;
    }

    Vendedor v;
    int i, total = tamanho(arq, sizeof(Vendedor));

    fprintf(rel, "======= RELATÓRIO DE VENDEDORES =======\n\n");
    for (i = 0; i < total; i++) {
        fseek(arq, i * sizeof(Vendedor), SEEK_SET);
        fread(&v, sizeof(Vendedor), 1, arq);
        fprintf(rel, "#%03d  %s\n", i + 1, v.nome);
    }

    fclose(rel);
    printf("Relatório 'relatorio_vendedores.txt' criado com sucesso!\n");
}

/* ============================================================================== */
/* ---- RELATÓRIO TXT DA VENDA ---- */
void gerarRelatorioVenda(Produto p, Vendedor v, int qtd, const char *data) {
    char nomeArquivo[60];
    snprintf(nomeArquivo, sizeof(nomeArquivo), "venda_%s.txt", p.nome);

    FILE *rel = fopen(nomeArquivo, "w");
    if (!rel) {
        printf("Erro ao criar relatório de venda!\n");
        return;
    }

    fprintf(rel, "======== COMPROVANTE DE VENDA ========\n\n");
    fprintf(rel, "Produto: %s\n", p.nome);
    fprintf(rel, "Preço unitário: R$ %.2f\n", p.preco);
    fprintf(rel, "Quantidade: %d\n", qtd);
    fprintf(rel, "Total: R$ %.2f\n\n", p.preco * qtd);
    fprintf(rel, "Vendedor: %s\n", v.nome);
    fprintf(rel, "Data: %s\n", data);

    fclose(rel);

    printf("Relatório da venda salvo em '%s'\n", nomeArquivo);
}

/* ============================================================================== */
int main(void) {
    FILE *arqProd = fopen("estoque.dat", "r+b");
    if (!arqProd) arqProd = fopen("estoque.dat", "w+b");

    FILE *arqVend = fopen("vendedores.dat", "r+b");
    if (!arqVend) arqVend = fopen("vendedores.dat", "w+b");

    if (!arqProd || !arqVend) {
        printf("Erro crítico ao abrir banco de dados.\n");
        return 1;
    }

    int op;
    do {
        printf("\n========== SISTEMA DE LOJA ==========\n");
        printf("1. Cadastrar Produto (Chegada de item)\n");
        printf("2. Cadastrar Vendedor\n");
        printf("3. REALIZAR VENDA (Saída de Estoque)\n");
        printf("4. Consultar Estoque Geral\n");
        printf("5. Listar Vendedores\n");
        printf("6. Sair\n");
        printf("7. Gerar relatório de Estoque TXT\n");
        printf("8. Gerar relatório de Vendedores TXT\n");
        printf("Opção: ");

        if (scanf("%d", &op) != 1) {
            limpa_buffer(); continue;
        }
        limpa_buffer();

        switch (op) {
            case 1: cadastrarProduto(arqProd); break;
            case 2: cadastrarVendedor(arqVend); break;
            case 3: realizarVenda(arqProd, arqVend); break;
            case 4: consultarEstoque(arqProd); break;
            case 5: listarVendedores(arqVend); break;
            case 7: gerarRelatorioEstoque(arqProd); break;
            case 8: gerarRelatorioVendedores(arqVend); break;
            case 6: printf("Fechando caixa...\n"); break;
            default: printf("Opção inválida!\n");
        }

    } while (op != 6);

    fclose(arqProd);
    fclose(arqVend);
    return 0;
}
