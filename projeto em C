/* ===================================================================================
       SISTEMA DE GESTÃO DE ESTOQUE E VENDAS (C PURO)
-----------------------------------------------------------------------------------
   FUNCIONALIDADES:
   - Cadastro de Produtos
   - Cadastro de Vendedores
   - Saída de Mercadoria (Baixa no Estoque com Vendedor e Data)
   - Relatórios em TXT
   - Exclusão de Produtos / Vendedores
   - Total de Registros
=================================================================================== */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

/* ==========================
   ESTRUTURAS DE DADOS
========================== */

typedef struct {
    int codigo;
    char nome[50];
    int quantidade;
    char status;   // ' ' = ativo | 'X' = excluído
} Produto;

typedef struct {
    int codigo;
    char nome[50];
    char status; // ' ' = ativo | 'X' = excluído
} Vendedor;

/* ==========================
   PROTÓTIPOS DAS FUNÇÕES
========================== */

void limpa_buffer();
void cadastrarProduto(FILE *arq);
void cadastrarVendedor(FILE *arq);
void listarProdutos(FILE *arq);
void listarVendedores(FILE *arq);
void gerarRelatorioProdutos();
void gerarRelatorioVendedores();
void saidaMercadoria(FILE *arqProd, FILE *arqVend);
void totalRegistros(void);

void excluirProduto(FILE *arq);
void excluirVendedor(FILE *arq);

/* ==========================
      LIMPAR BUFFER
========================== */
void limpa_buffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

/* ==========================
   CADASTRAR PRODUTO
========================== */
void cadastrarProduto(FILE *arq) {
    Produto p;

    fseek(arq, 0, SEEK_END);
    long tamanho = ftell(arq);

    p.codigo = (tamanho / sizeof(Produto)) + 1;
    p.status = ' ';

    printf("\nNome do produto: ");
    fgets(p.nome, 50, stdin);
    p.nome[strcspn(p.nome, "\n")] = 0;

    printf("Quantidade: ");
    scanf("%d", &p.quantidade);
    limpa_buffer();

    fwrite(&p, sizeof(Produto), 1, arq);

    printf("\nProduto cadastrado com sucesso! Código: %d\n", p.codigo);
}

/* ==========================
   CADASTRAR VENDEDOR
========================== */
void cadastrarVendedor(FILE *arq) {
    Vendedor v;

    fseek(arq, 0, SEEK_END);
    long tamanho = ftell(arq);

    v.codigo = (tamanho / sizeof(Vendedor)) + 1;
    v.status = ' ';

    printf("\nNome do vendedor: ");
    fgets(v.nome, 50, stdin);
    v.nome[strcspn(v.nome, "\n")] = 0;

    fwrite(&v, sizeof(Vendedor), 1, arq);

    printf("\nVendedor cadastrado com sucesso! Código: %d\n", v.codigo);
}

/* ==========================
   LISTAR PRODUTOS
========================== */
void listarProdutos(FILE *arq) {
    Produto p;
    rewind(arq);

    printf("\n====== PRODUTOS CADASTRADOS ======\n");

    while (fread(&p, sizeof(Produto), 1, arq) == 1) {
        if (p.status == ' ')
            printf("Código: %d | Nome: %s | Quantidade: %d\n",
                   p.codigo, p.nome, p.quantidade);
    }
}

/* ==========================
   LISTAR VENDEDORES
========================== */
void listarVendedores(FILE *arq) {
    Vendedor v;
    rewind(arq);

    printf("\n====== VENDEDORES CADASTRADOS ======\n");

    while (fread(&v, sizeof(Vendedor), 1, arq) == 1) {
        if (v.status == ' ')
            printf("Código: %d | Nome: %s\n",
                   v.codigo, v.nome);
    }
}

/* ==========================
   SAÍDA DE MERCADORIA
========================== */
void saidaMercadoria(FILE *arqProd, FILE *arqVend) {
    int codP, codV, qtd;
    Produto p;
    Vendedor v;

    printf("\nCódigo do produto: ");
    scanf("%d", &codP);
    limpa_buffer();

    long posP = (long)(codP - 1) * sizeof(Produto);
    fseek(arqProd, posP, SEEK_SET);

    if (fread(&p, sizeof(Produto), 1, arqProd) != 1 || p.status == 'X') {
        printf("Produto inválido!\n");
        return;
    }

    printf("Quantidade a dar baixa: ");
    scanf("%d", &qtd);
    limpa_buffer();

    if (qtd > p.quantidade) {
        printf("Erro: quantidade insuficiente!\n");
        return;
    }

    printf("Código do vendedor: ");
    scanf("%d", &codV);
    limpa_buffer();

    long posV = (long)(codV - 1) * sizeof(Vendedor);
    fseek(arqVend, posV, SEEK_SET);

    if (fread(&v, sizeof(Vendedor), 1, arqVend) != 1 || v.status == 'X') {
        printf("Vendedor inválido!\n");
        return;
    }

    p.quantidade -= qtd;
    fseek(arqProd, posP, SEEK_SET);
    fwrite(&p, sizeof(Produto), 1, arqProd);
    fflush(arqProd);

    /* Gerar arquivo TXT da venda */
    char nomeArq[50];
    sprintf(nomeArq, "venda_%d_%d.txt", p.codigo, v.codigo);

    FILE *txt = fopen(nomeArq, "w");
    fprintf(txt, "SAÍDA DE MERCADORIA\n\n");
    fprintf(txt, "Produto: %s\n", p.nome);
    fprintf(txt, "Quantidade: %d\n", qtd);
    fprintf(txt, "Vendedor: %s\n", v.nome);
    fclose(txt);

    printf("\nSaída registrada com sucesso!\n");
}

/* ==========================
   GERAR RELATÓRIO PRODUTOS
========================== */
void gerarRelatorioProdutos() {
    FILE *arq = fopen("estoque.dat", "rb");
    FILE *txt = fopen("relatorio_produtos.txt", "w");

    Produto p;
    rewind(arq);

    while (fread(&p, sizeof(Produto), 1, arq) == 1) {
        if (p.status == ' ')
            fprintf(txt, "%d;%s;%d\n", p.codigo, p.nome, p.quantidade);
    }

    fclose(arq);
    fclose(txt);

    printf("\nRelatório de PRODUTOS gerado!\n");
}

/* ==========================
   GERAR RELATÓRIO VENDEDORES
========================== */
void gerarRelatorioVendedores() {
    FILE *arq = fopen("vendedores.dat", "rb");
    FILE *txt = fopen("relatorio_vendedores.txt", "w");

    Vendedor v;
    rewind(arq);

    while (fread(&v, sizeof(Vendedor), 1, arq) == 1) {
        if (v.status == ' ')
            fprintf(txt, "%d;%s\n", v.codigo, v.nome);
    }

    fclose(arq);
    fclose(txt);

    printf("\nRelatório de VENDEDORES gerado!\n");
}

/* ==========================
   EXCLUIR PRODUTO
========================== */
void excluirProduto(FILE *arq) {
    int cod;
    Produto p;
    char opc;

    printf("\n--- EXCLUIR PRODUTO ---\n");
    printf("Código do produto: ");
    scanf("%d", &cod);
    limpa_buffer();

    long pos = (long)(cod - 1) * sizeof(Produto);
    fseek(arq, pos, SEEK_SET);

    if (fread(&p, sizeof(Produto), 1, arq) != 1 || p.status == 'X') {
        printf("Produto inválido!\n");
        return;
    }

    printf("\nProduto encontrado: %s (Qtd: %d)\n", p.nome, p.quantidade);
    printf("Confirma excluir? (S/N): ");
    scanf("%c", &opc);
    limpa_buffer();

    if (opc != 'S' && opc != 's') {
        printf("Exclusão cancelada!\n");
        return;
    }

    p.status = 'X';
    fseek(arq, pos, SEEK_SET);
    fwrite(&p, sizeof(Produto), 1, arq);

    printf("Produto excluído com sucesso!\n");
}

/* ==========================
   EXCLUIR VENDEDOR
========================== */
void excluirVendedor(FILE *arq) {
    int cod;
    Vendedor v;
    char opc;

    printf("\n--- EXCLUIR VENDEDOR ---\n");
    printf("Código do vendedor: ");
    scanf("%d", &cod);
    limpa_buffer();

    long pos = (long)(cod - 1) * sizeof(Vendedor);
    fseek(arq, pos, SEEK_SET);

    if (fread(&v, sizeof(Vendedor), 1, arq) != 1 || v.status == 'X') {
        printf("Vendedor inválido!\n");
        return;
    }

    printf("\nVendedor encontrado: %s\n", v.nome);
    printf("Confirma excluir? (S/N): ");
    scanf("%c", &opc);
    limpa_buffer();

    if (opc != 'S' && opc != 's') {
        printf("Exclusão cancelada!\n");
        return;
    }

    v.status = 'X';
    fseek(arq, pos, SEEK_SET);
    fwrite(&v, sizeof(Vendedor), 1, arq);

    printf("Vendedor excluído com sucesso!\n");
}

/* ==========================
   TOTAL DE REGISTROS
========================== */
void totalRegistros() {
    FILE *arqProd = fopen("estoque.dat", "rb");
    FILE *arqVend = fopen("vendedores.dat", "rb");

    int totalProdutos = 0, totalVendedores = 0;

    if (arqProd) {
        fseek(arqProd, 0, SEEK_END);
        totalProdutos = ftell(arqProd) / sizeof(Produto);
        fclose(arqProd);
    }

    if (arqVend) {
        fseek(arqVend, 0, SEEK_END);
        totalVendedores = ftell(arqVend) / sizeof(Vendedor);
        fclose(arqVend);
    }

    system("dir /b venda_*.txt > vendas.tmp");
    FILE *tmp = fopen("vendas.tmp", "r");

    int totalVendas = 0;
    char linha[200];

    if (tmp) {
        while (fgets(linha, sizeof(linha), tmp))
            totalVendas++;
        fclose(tmp);
        remove("vendas.tmp");
    }

    printf("\n=========== TOTAL DE REGISTROS ===========\n");
    printf("Produtos cadastrados ......: %d\n", totalProdutos);
    printf("Vendedores cadastrados ....: %d\n", totalVendedores);
    printf("Vendas registradas (TXT) ..: %d\n", totalVendas);
    printf("==========================================\n");
}

/* ==========================
              MAIN
========================== */
int main() {

    FILE *arqProd = fopen("estoque.dat", "r+b");
    if (!arqProd) arqProd = fopen("estoque.dat", "w+b");

    FILE *arqVend = fopen("vendedores.dat", "r+b");
    if (!arqVend) arqVend = fopen("vendedores.dat", "w+b");

    int op;

    do {
        printf("\n==============================\n");
        printf("      SISTEMA DE ESTOQUE\n");
        printf("==============================\n");
        printf("1 - Cadastrar Produto\n");
        printf("2 - Cadastrar Vendedor\n");
        printf("3 - Listar Produtos\n");
        printf("4 - Listar Vendedores\n");
        printf("5 - Saída de Mercadoria\n");
        printf("6 - Gerar relatório Produtos TXT\n");
        printf("7 - Gerar relatório Vendedores TXT\n");
        printf("8 - Total de registros\n");
        printf("9 - Excluir Produto\n");
        printf("10 - Excluir Vendedor\n");
        printf("0 - Sair\n");
        printf("Escolha: ");
        scanf("%d", &op);
        limpa_buffer();

        switch (op) {
        case 1: cadastrarProduto(arqProd); break;
        case 2: cadastrarVendedor(arqVend); break;
        case 3: listarProdutos(arqProd); break;
        case 4: listarVendedores(arqVend); break;
        case 5: saidaMercadoria(arqProd, arqVend); break;
        case 6: gerarRelatorioProdutos(); break;
        case 7: gerarRelatorioVendedores(); break;
        case 8: totalRegistros(); break;
        case 9: excluirProduto(arqProd); break;
        case 10: excluirVendedor(arqVend); break;
        case 0: printf("\nEncerrando...\n"); break;
        default: printf("Opção inválida!\n");
        }

    } while (op != 0);

    fclose(arqProd);
    fclose(arqVend);

    return 0;
}
